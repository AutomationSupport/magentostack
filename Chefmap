---
id: magentostack
name: magento
roles: [master]
is: application
provides:
- application: http
requires:
- host: linux
- database: mysql
supports:
- session-cache:
    interface: {from: [redis]}
    resource_type: cache
- object-cache:
    interface: {from: [redis]}
    resource_type: cache
- page-cache:
    interface: {from: [redis]}
    resource_type: cache
options:
  "domain":
    type: string
  "admin_frontname":
    type: string
    default: admin
  "firstname":
    type: string
    default: Admin
  "lastname":
    type: string
    default: User
  "email":
    type: string
    required: true
  "newrelic":
    type: string
  "username":
    type: string
    default: MagentoAdmin
    required: true
  "password":
    type: string
    default: =generate_password(min_length=12, required_chars=["0123456789", "abcdefghijklmnopqrstuvwxyz", "ABCDEFGHIJKLMNOPQRSTUVWXYZ"])
    required: true
  "demo":
    type: boolean
    default: true
    required: true
  "newrelic":
    type: boolean
    default: false
    required: true
#  "database_privileges":
#    type: string
#    default: all
#    required: true
  "database_prefix":
    type: string
    default: magento_
run-list:
  recipes:
  - magentostack::apache-fpm
  - magentostack::magento_install
  - magentostack::newrelic
  - magentostack::_find_mysql
  - magentostack::magento_configure
maps:
- value: {{ setting('domain') }}
  targets:
  - attributes://magentostack/web/domain
- value: {{ setting('demo') }}
  targets:
  - attributes://magentostack/demo/enabled
- value: {{ setting('newrelic') }}
  targets:
  - attributes://magentostack/newrelic/application_monitoring/php/enabled
- value: {{ setting('admin_frontname') }}
  targets:
  - attributes://magentostack/config/admin_frontname
- value: {{ setting('firstname') }}
  targets:
  - attributes://magentostack/config/admin_user/firstname
- value: {{ setting('lastname') }}
  targets:
  - attributes://magentostack/config/admin_user/lastname
- value: {{ setting('email') }}
  targets:
  - attributes://magentostack/config/admin_user/email
- value: {{ setting('newrelic') }}
  targets:
  - attributes://newrelic/license
- value: {{ setting('username') }}
  targets:
  - attributes://magentostack/config/admin_user/username
  - outputs://resources/{{resource.index}}/instance/interfaces/magento/username
- value: {{ setting('password') }}
  targets:
  - attributes://magentostack/config/admin_user/password/
  - outputs://resources/{{resource.index}}/instance/interfaces/magento/password
# Database Setup (Values required by MySQL cookbook)
- source: requirements://database:mysql/host
  targets:
  - attributes://mysql-multi/master
- source: requirements://database:mysql/database_username
  targets:
  - attributes://magentostack/mysql/databases/magento_database/mysql_user
  - outputs://resources/{{resource.index}}/instance/interfaces/mysql/magento/username
- source: requirements://database:mysql/database_root_password
  targets:
  - attributes://magentostack/mysql/databases/magento_database/mysql_password
  - outputs://resources/{{resource.index}}/instance/interfaces/mysql/magento/password
- value: "all"
  targets:
  - attributes://magentostack/mysql/databases/magento_database/privileges
- source: supported://session-cache/instance/name
  targets:
  - attributes://magentostack/redis/override_session_name
- source: supported://session-cache/host
  targets:
  - attributes://magentostack/redis/override_session_host
- source: supported://session-cache/port
  targets:
  - attributes://magentostack/redis/override_session_port
- source: supported://object-cache/instance/name
  targets:
  - attributes://magentostack/redis/override_object_name
- source: supported://object-cache/host
  targets:
  - attributes://magentostack/redis/override_object_host
- source: supported://object-cache/port
  targets:
  - attributes://magentostack/redis/override_object_port
- source: supported://page-cache/instance/name
  targets:
  - attributes://magentostack/redis/override_page_name
- source: supported://page-cache/host
  targets:
  - attributes://magentostack/redis/override_page_host
- source: supported://page-cache/port
  targets:
  - attributes://magentostack/redis/override_page_port

output:
  resources:
    '{{resource.index}}':
      instance:
        interfaces:
          magento:
            username: {{setting('username')}}
            password: {{setting('password')}}
          mysql:
            server_root_password: {{ setting('database_root_password') }}
            magento:
              password: {{setting('database_password')}}
              username: {{setting('database_username')}}
              # note host is written as output of a map

---
id: mysqlmaster
name: mysql
roles: [master]
is: database
provides:
- database: mysql
requires:
- host: linux
options:
  "database_root_password":
    type: string
    default: =generate_password(min_length=12, required_chars=["0123456789", "abcdefghijklmnopqrstuvwxyz", "ABCDEFGHIJKLMNOPQRSTUVWXYZ"])
    required: true
run_list:
  - magentostack::mysql_master
  - magentostack::mysql_holland
maps:
- value: {{ setting('database_root_password') }}
  targets:
  - attributes://mysql/server_root_password
  - outputs://resources/{{resource.index}}/instance/interfaces/mysql/server_root_password
output:
  resources:
    '{{resource.index}}'
      instance:
        interfaces:
          mysql:
            host: requirements://host:linux/private_ip
            server_root_password: {{ setting('database_root_password') }}

---
id: magentoredis
name: redis
is: cache
provides:
- cache: redis
requires:
- host: linux
options:
  "name":
    type: string
    default: cache_type
    required: true
    constraints:
    - in: ["sessions", "objects", "FPC"]
  "port":
    type: string
    default: 27017
    required: true
run_list:
- magentostack::redis_single
- magentostack::redis_configure
maps:
- value: {{ setting('name') }}
  targets:
  attributes://magentostack/redis/bind_port_single
output:
  resources:
    '{{resource.index}}'
      instance:
        name: {{ settings('name') }}
        interfaces:
          redis:
            host: requirements://host:linux/private_ip
            port: {{ settings('port') }}
